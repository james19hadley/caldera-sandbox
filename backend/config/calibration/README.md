# Caldera Sensor Calibration System

## Обзор

Система калибровки Caldera предназначена для точной настройки сенсоров глубины (Kinect v1/v2) для работы с песочницей дополненной реальности. Калибровка определяет базовую плоскость песочницы и создает систему координат для обработки данных в реальном времени.

## Что такое калибровка?

Калибровка - это процесс измерения и сохранения параметров базовой плоскости песочницы:

- **Базовая плоскость** - ровная поверхность песка без объектов
- **Система координат** - привязка пикселей глубины к реальным координатам (метры)
- **Пороги валидности** - границы для фильтрации шума и артефактов

### Зачем нужна калибровка?

1. **Определение "нулевого уровня"** - базовая высота песка
2. **Фильтрация данных** - отсеивание некорректных измерений
3. **Масштабирование** - перевод из пикселей в метры
4. **Стабильность** - компенсация дрифта сенсора

## Структура файлов

```
config/calibration/
├── README.md                          # Этот файл
├── kinect-v1_calibration.json         # Профиль калибровки Kinect v1
├── kinect-v2_calibration.json         # Профиль калибровки Kinect v2 (если есть)
└── [sensor-id]_calibration.json       # Профили других сенсоров
```

## Формат профиля калибровки

### Структура JSON файла:

```json
{
  "sensorId": "A00363A01039120A",           // Серийный номер сенсора
  "sensorType": "kinect-v1",               // Тип сенсора
  "basePlaneCalibration": {
    "pointCount": 20,                      // Количество калибровочных точек
    "basePlane": {
      "a": 0.0000,                         // Коэффициенты плоскости:
      "b": 0.0000,                         // ax + by + cz + d = 0
      "c": 1.0000,                         // (для горизонтальной плоскости)
      "d": -0.9267                         // Высота плоскости в метрах
    },
    "avgDistanceToPlane": 0.0045,          // Средняя погрешность (м)
    "maxDistanceToPlane": 0.0153,          // Максимальная погрешность (м)
    "planeFitRSquared": 0.6517,            // Качество аппроксимации (0-1)
    "isValidCalibration": true             // Флаг валидности
  }
}
```

### Интерпретация параметров:

- **d = -0.9267**: Базовая плоскость находится на расстоянии 92.67см от сенсора
- **avgDistanceToPlane = 0.0045**: Средняя погрешность 4.5мм (отличный результат)
- **maxDistanceToPlane = 0.0153**: Максимальное отклонение 15.3мм (приемлемо)
- **planeFitRSquared = 0.6517**: R² = 65% (хорошо для реальных условий)

## Использование CalibrationTool

### Основные команды:

```bash
# Показать справку
./CalibrationTool help

# Показать доступные сенсоры
./CalibrationTool list-sensors

# Калибровка (автоматический режим)
./CalibrationTool calibrate kinect-v1

# Калибровка с отладочным выводом
./CalibrationTool calibrate kinect-v1 --debug

# Показать сохраненный профиль
./CalibrationTool show kinect-v1

# Валидация существующей калибровки
./CalibrationTool validate kinect-v1

# Список всех профилей
./CalibrationTool list-profiles

# Удаление профиля
./CalibrationTool delete kinect-v1
```

### Процесс калибровки:

1. **Подготовка**: Разровняйте песок, уберите все объекты
2. **Запуск**: `./CalibrationTool calibrate kinect-v1`
3. **Сбор данных**: Автоматически собирается 20 точек по сетке в центре кадра
4. **Анализ**: Фиттинг плоскости методом наименьших квадратов
5. **Валидация**: Проверка качества по порогам
6. **Сохранение**: Профиль сохраняется в JSON файл

## Пороги качества

Система использует следующие критерии валидности:

```cpp
maxAvgDistanceToPlane = 0.02f;      // Макс. средняя погрешность: 2см
maxDistanceToPlane = 0.05f;         // Макс. отклонение точки: 5см  
minPlaneFitRSquared = 0.60f;        // Мин. R² для аппроксимации: 60%
```

### Интерпретация результатов:

- **R² > 0.8**: Отличное качество (идеальная плоскость)
- **R² 0.6-0.8**: Хорошее качество (нормальные условия песочницы)
- **R² 0.4-0.6**: Удовлетворительное (неровная поверхность)
- **R² < 0.4**: Неприемлемо (перекалибровка необходима)

## Технические детали

### Алгоритм калибровки:

1. **Инициализация сенсора** - подключение и запуск потока данных
2. **Сбор точек** - грид 5×5 в центральной области (640×480)
3. **Преобразование координат** - из пикселей глубины в 3D точки
4. **Фиттинг плоскости** - аппроксимация горизонтальной плоскости z = const
5. **Расчет метрик качества** - средние/максимальные отклонения, R²
6. **Валидация** - проверка по порогам качества
7. **Сериализация** - сохранение в JSON с timestamp

### Формула плоскости:

Для горизонтальной песочницы используется упрощенная модель:
```
ax + by + cz + d = 0
где: a=0, b=0, c=1 (нормаль направлена вверх)
z = -d (высота плоскости)
```

### Преобразование координат:

```cpp
// Из пикселя (x,y) и глубины depth в 3D точку:
float worldX = (x - centerX) * depth * pixelScale;
float worldY = (y - centerY) * depth * pixelScale; 
float worldZ = depth;  // глубина напрямую
```

## Troubleshooting

### Частые проблемы:

**"Insufficient points collected"**
- Убедитесь что сенсор видит плоскую поверхность
- Проверьте подключение и драйверы
- Используйте `--debug` для диагностики

**"Calibration does not meet quality thresholds"**
- Разровняйте поверхность песка
- Уберите объекты из поля зрения
- Проверьте освещение (избегайте прямых солнечных лучей)

**"Sensor not available"**
- Проверьте USB подключение
- Убедитесь что сенсор не используется другим процессом
- Перезапустите CalibrationTool

### Debug режим:

Используйте `--debug` флаг для подробной диагностики:

```bash
./CalibrationTool calibrate kinect-v1 --debug
```

Вывод включает:
- Координаты всех собранных точек
- Параметры аппроксимированной плоскости
- Детальные метрики качества
- Результаты валидации по каждому критерию

## История версий

- **v1.0**: Первоначальная реализация с поддержкой Kinect v1/v2
- **v1.1**: Добавлен debug режим и улучшена валидация
- **v1.2**: Оптимизированы пороги качества для реальных условий

## Программный API

### Использование в коде:

```cpp
#include "tools/calibration/SensorCalibration.h"

using namespace caldera::backend::tools::calibration;

// Создание калибратора
SensorCalibration calibrator;

// Загрузка профиля
auto profile = calibrator.loadProfile("kinect-v1");
if (profile) {
    auto& plane = profile->basePlaneCalibration.basePlane;
    float baseHeight = -plane.d;  // Высота базовой плоскости
    
    // Проверка валидности точки
    Point3D point(x, y, z);
    float distanceToBase = plane.distanceToPoint(point);
    
    if (distanceToBase < 0.30f) {  // Точка в пределах 30см от базы
        // Обработать точку...
    }
}

// Программная калибровка
auto sensor = std::make_shared<KinectV1_Device>();
auto result = calibrator.performAutomaticCalibration(sensor);

if (result == CalibrationResult::Success) {
    calibrator.saveProfile("kinect-v1");
}
```

### Интеграция с ProcessingManager:

```cpp
// В конструкторе ProcessingManager
auto calibProfile = calibrator_.loadProfile(sensorId);
if (calibProfile) {
    basePlane_ = calibProfile->basePlaneCalibration.basePlane;
}

// В обработке кадра
float heightAboveBase = -basePlane_.evaluatePoint(worldPoint);
if (heightAboveBase > 0.02f && heightAboveBase < 0.30f) {
    // Точка валидна для визуализации
}
```

## См. также

- [Architectural Overview](../../01_Architectural_Overview.md) - общая архитектура системы
- [Design Decisions](../../02_Design_Decisions.md) - проектные решения
- `src/tools/calibration/` - исходный код системы калибровки
- `src/hal/` - драйверы сенсоров
- `src/processing/` - использование калибровки в обработке данных